# ä¸­è½¬ç«™æ¨¡å¼é›†æˆå®ŒæˆæŠ¥å‘Š

## âœ… é›†æˆçŠ¶æ€ï¼šå®Œæˆå¹¶æµ‹è¯•é€šè¿‡

**å®Œæˆæ—¶é—´**: 2026-02-04
**ç‰ˆæœ¬**: v2.1.0
**åŠŸèƒ½**: ä¸­è½¬ç«™æ¨¡å¼ (Relay Mode)

---

## ğŸ“Š æµ‹è¯•ç»“æœ

### API ç«¯ç‚¹æµ‹è¯•

| ç«¯ç‚¹ | çŠ¶æ€ | å“åº”æ—¶é—´ | è¯´æ˜ |
|------|------|----------|------|
| `/v1/chat/completions` | âœ… PASS | ~6s | Chat åŠŸèƒ½æ­£å¸¸ |
| `/v1/images/generations` | âœ… PASS | ~10s | å›¾ç‰‡ç”Ÿæˆæ­£å¸¸ |

### åŠŸèƒ½éªŒè¯

- âœ… ä¸­è½¬ç«™ API å®¢æˆ·ç«¯æ­£å¸¸å·¥ä½œ
- âœ… ç»Ÿä¸€å®¢æˆ·ç«¯è‡ªåŠ¨æ¨¡å¼åˆ‡æ¢
- âœ… Chat Completions ç«¯ç‚¹é›†æˆæˆåŠŸ
- âœ… Image Generation ç«¯ç‚¹é›†æˆæˆåŠŸ
- âœ… API Key è®¤è¯ç³»ç»Ÿå…¼å®¹
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„
- âœ… æ—¥å¿—è®°å½•åŠŸèƒ½æ­£å¸¸

---

## ğŸ¯ ä¸­è½¬ç«™ä¿¡æ¯

### API é…ç½®

```env
RELAY_ENABLED=true
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q
RELAY_CHAT_MODEL=grok-4-fast
RELAY_IMAGE_MODEL=grok-imagine-0.9
```

### æ”¯æŒçš„æ¨¡å‹

- **Chat**: `grok-4-fast`, `grok-3-fast`, `grok-4-expert`
- **Image**: `grok-imagine-0.9` (é€šè¿‡ä¸­è½¬ç«™)

---

## ğŸ“ æ–°å¢/ä¿®æ”¹æ–‡ä»¶

### æ ¸å¿ƒä»£ç 

1. **app/services/relay_client.py** (æ–°å¢)
   - ä¸­è½¬ç«™ HTTP API å®¢æˆ·ç«¯
   - æ”¯æŒ Chat Completions å’Œ Image Generation
   - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œè¶…æ—¶æ§åˆ¶

2. **app/services/unified_client.py** (æ–°å¢)
   - ç»Ÿä¸€å®¢æˆ·ç«¯æ¥å£
   - è‡ªåŠ¨é€‰æ‹©ç›´è¿æˆ–ä¸­è½¬ç«™æ¨¡å¼
   - é€æ˜çš„æ¨¡å¼åˆ‡æ¢

3. **app/core/config.py** (ä¿®æ”¹)
   - æ·»åŠ ä¸­è½¬ç«™é…ç½®é¡¹
   - æ”¯æŒç¯å¢ƒå˜é‡é…ç½®

4. **app/api/chat.py** (ä¿®æ”¹)
   - é›†æˆä¸­è½¬ç«™æ¨¡å¼
   - ä¿æŒå‘åå…¼å®¹

5. **app/api/imagine.py** (ä¿®æ”¹)
   - é›†æˆä¸­è½¬ç«™æ¨¡å¼
   - æ”¯æŒä¸¤ç§æ¨¡å¼åˆ‡æ¢

### æµ‹è¯•è„šæœ¬

- `test_relay.py` - åŸºç¡€åŠŸèƒ½æµ‹è¯•
- `test_relay_models.py` - æ¨¡å‹åˆ—è¡¨æµ‹è¯•
- `test_relay_correct.py` - æ­£ç¡®æ¨¡å‹æµ‹è¯•
- `test_integration.py` - é›†æˆæµ‹è¯•
- `test_api_relay.py` - API ç«¯ç‚¹æµ‹è¯• â­

### æ–‡æ¡£

- `README_ä¸­è½¬ç«™.md` - ä¸­è½¬ç«™æ¨¡å¼è¯´æ˜
- `æ›´æ–°è¯´æ˜_ä¸­è½¬ç«™.md` - æ›´æ–°è¯´æ˜
- `ä¸­è½¬ç«™é›†æˆå®ŒæˆæŠ¥å‘Š.md` - æœ¬æ–‡æ¡£ â­

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. é…ç½®ç¯å¢ƒå˜é‡

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
# å¯ç”¨ä¸­è½¬ç«™æ¨¡å¼
RELAY_ENABLED=true

# ä¸­è½¬ç«™ API é…ç½®
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q

# æ¨¡å‹é…ç½®ï¼ˆå¯é€‰ï¼‰
RELAY_CHAT_MODEL=grok-4-fast
RELAY_IMAGE_MODEL=grok-imagine-0.9
```

### 2. å¯åŠ¨æœåŠ¡

```bash
python main.py
```

æœåŠ¡å°†åœ¨ `http://localhost:9563` å¯åŠ¨ã€‚

### 3. æµ‹è¯• API

#### Chat Completions

```bash
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer admin" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "grok-4-fast",
    "messages": [{"role": "user", "content": "Hello"}],
    "stream": false
  }'
```

#### Image Generation

```bash
curl -X POST http://localhost:9563/v1/images/generations \
  -H "Authorization: Bearer admin" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "a beautiful sunset",
    "model": "grok-imagine",
    "n": 2,
    "size": "1024x1536"
  }'
```

---

## ğŸ”„ æ¨¡å¼åˆ‡æ¢

### å¯ç”¨ä¸­è½¬ç«™æ¨¡å¼

```env
RELAY_ENABLED=true
```

- æ‰€æœ‰è¯·æ±‚é€šè¿‡ä¸­è½¬ç«™ API
- æ— éœ€ SSO Token
- ä½¿ç”¨ API Key è®¤è¯

### ç¦ç”¨ä¸­è½¬ç«™æ¨¡å¼ï¼ˆç›´è¿ï¼‰

```env
RELAY_ENABLED=false
```

- ç›´æ¥è¿æ¥ Grok WebSocket
- éœ€è¦ SSO Token
- ä½¿ç”¨åŸæœ‰è®¤è¯æ–¹å¼

**é‡å¯æœåŠ¡åç”Ÿæ•ˆ**

---

## ğŸ“Š æ¶æ„è¯´æ˜

### è¯·æ±‚æµç¨‹

```
ç”¨æˆ·è¯·æ±‚
  â†“
API ç«¯ç‚¹ (chat.py / imagine.py)
  â†“
æ£€æŸ¥ RELAY_ENABLED
  â†“
â”œâ”€ true â†’ unified_client â†’ relay_client â†’ ä¸­è½¬ç«™ API
â””â”€ false â†’ grok_client â†’ Grok WebSocket (ç›´è¿)
```

### æ¨¡å¼é€‰æ‹©é€»è¾‘

```python
# åœ¨ API ç«¯ç‚¹ä¸­
if settings.RELAY_ENABLED:
    # ä½¿ç”¨ä¸­è½¬ç«™æ¨¡å¼
    result = await unified_client.chat_completion(...)
else:
    # ä½¿ç”¨ç›´è¿æ¨¡å¼
    result = await grok_client.generate(...)
```

---

## ğŸ‰ ä¼˜åŠ¿æ€»ç»“

### ä¸­è½¬ç«™æ¨¡å¼ä¼˜åŠ¿

1. **æ›´ç®€å•** - æ ‡å‡† HTTP APIï¼Œæ— éœ€ WebSocket
2. **æ›´ç¨³å®š** - æˆç†Ÿçš„ API æœåŠ¡
3. **æ— éœ€ SSO** - ä½¿ç”¨ API Key è®¤è¯
4. **æ˜“äºç»´æŠ¤** - æ ‡å‡† OpenAI æ ¼å¼
5. **å¿«é€Ÿåˆ‡æ¢** - é…ç½®å³å¯åˆ‡æ¢æ¨¡å¼

### å…¼å®¹æ€§

- âœ… å®Œå…¨å…¼å®¹ç°æœ‰ API Key ç®¡ç†ç³»ç»Ÿ
- âœ… ä¿æŒ OpenAI å…¼å®¹çš„ API æ ¼å¼
- âœ… æ”¯æŒæµå¼å’Œéæµå¼å“åº”
- âœ… å‘åå…¼å®¹ç›´è¿æ¨¡å¼

---

## ğŸ“ ä»£ç ç¤ºä¾‹

### Python å®¢æˆ·ç«¯

```python
import requests

# Chat Completions
response = requests.post(
    "http://localhost:9563/v1/chat/completions",
    headers={"Authorization": "Bearer admin"},
    json={
        "model": "grok-4-fast",
        "messages": [{"role": "user", "content": "Hello"}]
    }
)
print(response.json())

# Image Generation
response = requests.post(
    "http://localhost:9563/v1/images/generations",
    headers={"Authorization": "Bearer admin"},
    json={
        "prompt": "a beautiful sunset",
        "n": 2
    }
)
print(response.json())
```

### JavaScript å®¢æˆ·ç«¯

```javascript
// Chat Completions
const response = await fetch('http://localhost:9563/v1/chat/completions', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer admin',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    model: 'grok-4-fast',
    messages: [{role: 'user', content: 'Hello'}]
  })
});
const data = await response.json();
console.log(data);
```

---

## ğŸ§ª æµ‹è¯•å‘½ä»¤

```bash
# é›†æˆæµ‹è¯•
python test_integration.py

# API ç«¯ç‚¹æµ‹è¯•
python test_api_relay.py

# æ¨¡å‹åˆ—è¡¨æµ‹è¯•
python test_relay_models.py

# åŠŸèƒ½æµ‹è¯•
python test_relay_correct.py
```

---

## ğŸ“ æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæœåŠ¡å¯åŠ¨å¤±è´¥

**æ£€æŸ¥**:
- `.env` æ–‡ä»¶é…ç½®æ˜¯å¦æ­£ç¡®
- ç«¯å£ 9563 æ˜¯å¦è¢«å ç”¨
- Python ä¾èµ–æ˜¯å¦å®‰è£…å®Œæ•´

### é—®é¢˜ï¼šAPI è¿”å› 401

**æ£€æŸ¥**:
- Authorization header æ˜¯å¦æ­£ç¡®
- API Key æ˜¯å¦æœ‰æ•ˆï¼ˆé»˜è®¤ï¼šadminï¼‰

### é—®é¢˜ï¼šä¸­è½¬ç«™è¿æ¥å¤±è´¥

**æ£€æŸ¥**:
- `RELAY_BASE_URL` æ˜¯å¦æ­£ç¡®
- `RELAY_API_KEY` æ˜¯å¦æœ‰æ•ˆ
- ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸

### é—®é¢˜ï¼šæƒ³åˆ‡æ¢å›ç›´è¿æ¨¡å¼

**è§£å†³**:
```env
RELAY_ENABLED=false
SSO_FILE=key.txt  # ç¡®ä¿æœ‰ SSO Token
```

---

## ğŸ“ˆ æ€§èƒ½æ•°æ®

### å“åº”æ—¶é—´

- Chat Completions: ~6 ç§’
- Image Generation: ~10 ç§’ï¼ˆ2å¼ å›¾ç‰‡ï¼‰

### å¹¶å‘æ”¯æŒ

- æ”¯æŒå¤šä¸ªå¹¶å‘è¯·æ±‚
- è‡ªåŠ¨ä¼šè¯ç®¡ç†
- è¿æ¥æ± ä¼˜åŒ–

---

## ğŸ¯ ä¸‹ä¸€æ­¥å»ºè®®

### æ¨èé…ç½®

**ç”Ÿäº§ç¯å¢ƒ**:
```env
RELAY_ENABLED=true
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=your-api-key
```

**å¼€å‘ç¯å¢ƒ**:
```env
RELAY_ENABLED=false
SSO_FILE=key.txt
```

### åŠŸèƒ½æ‰©å±•

1. æ·»åŠ æ›´å¤šä¸­è½¬ç«™æ”¯æŒ
2. å®ç°è´Ÿè½½å‡è¡¡
3. æ·»åŠ ç¼“å­˜æœºåˆ¶
4. ç›‘æ§å’Œç»Ÿè®¡åŠŸèƒ½

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [README_ä¸­è½¬ç«™.md](./README_ä¸­è½¬ç«™.md) - ä¸­è½¬ç«™æ¨¡å¼è¯´æ˜
- [æ›´æ–°è¯´æ˜_ä¸­è½¬ç«™.md](./æ›´æ–°è¯´æ˜_ä¸­è½¬ç«™.md) - æ›´æ–°è¯´æ˜
- [test_api_relay.py](./test_api_relay.py) - API æµ‹è¯•è„šæœ¬

---

## âœ… æ€»ç»“

### å·²å®Œæˆ

1. âœ… ä¸­è½¬ç«™ API å®¢æˆ·ç«¯å®ç°
2. âœ… ç»Ÿä¸€å®¢æˆ·ç«¯æ¥å£
3. âœ… API ç«¯ç‚¹é›†æˆ
4. âœ… é…ç½®ç®¡ç†ç³»ç»Ÿ
5. âœ… å®Œæ•´æµ‹è¯•éªŒè¯
6. âœ… è¯¦ç»†æ–‡æ¡£ç¼–å†™

### æµ‹è¯•é€šè¿‡

- âœ… Chat Completions API
- âœ… Image Generation API
- âœ… æ¨¡å¼åˆ‡æ¢åŠŸèƒ½
- âœ… é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… API Key è®¤è¯

### ç”Ÿäº§å°±ç»ª

ä¸­è½¬ç«™æ¨¡å¼å·²ç»å®Œå…¨é›†æˆå¹¶æµ‹è¯•é€šè¿‡ï¼Œå¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚

---

**ğŸ‰ é›†æˆå®Œæˆï¼ç°åœ¨å¯ä»¥ä½¿ç”¨ä¸­è½¬ç«™æ¨¡å¼äº†ï¼**

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2026-02-04*
*ç‰ˆæœ¬: v2.1.0*
*çŠ¶æ€: ç”Ÿäº§å°±ç»ª*
