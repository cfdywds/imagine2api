# 中转站模式 - 快速配置

## ✅ 已完成的工作

我已经为你的项目添加了**中转站模式**支持！现在你可以通过中转站 API 使用服务，而不需要 Grok SSO Token。

---

## 🚀 快速配置（3步）

### 第 1 步：编辑配置文件

打开 `.env` 文件，找到中转站配置部分，修改为：

```env
# ============ 中转站配置 ============
# 启用中转站模式
RELAY_ENABLED=true

# 中转站 API 地址
RELAY_BASE_URL=https://api.yexc.top/v1

# 中转站 API Key
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q

# 默认模型（可选）
RELAY_CHAT_MODEL=grok-4-fast
RELAY_IMAGE_MODEL=grok-imagine-0.9
```

### 第 2 步：重启服务

```bash
python main.py
```

### 第 3 步：测试

```bash
# 测试 Chat（推荐使用，已验证可用）
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer admin" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "grok-4-fast",
    "messages": [{"role": "user", "content": "你好"}],
    "stream": false
  }'
```

---

## 📊 测试结果

根据测试，你的中转站：

### ✅ 可用功能
- **Chat Completions** - 完全可用
  - 模型：`grok-4-fast`、`grok-3-fast`、`grok-4-expert` 等
  - 状态：✅ 测试通过

### ⚠️ 待确认功能
- **图片生成** - 接口返回 404
  - 可能需要联系中转站提供商启用
  - 或使用直连模式生成图片

---

## 🎯 推荐配置

### 配置 1：仅使用中转站（Chat）

```env
# 启用中转站
RELAY_ENABLED=true
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q
RELAY_CHAT_MODEL=grok-4-fast
```

**适用场景**：只需要 Chat 功能

### 配置 2：混合模式（推荐）

```env
# 启用中转站（用于 Chat）
RELAY_ENABLED=true
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q

# 保留 SSO 配置（用于图片生成）
SSO_FILE=key.txt
```

**适用场景**：Chat 使用中转站，图片生成使用直连

---

## 📁 新增文件

### 核心代码
- `app/services/relay_client.py` - 中转站 API 客户端
- `app/services/unified_client.py` - 统一客户端（自动选择模式）

### 测试脚本
- `test_relay.py` - 基本测试
- `test_relay_models.py` - 模型列表测试
- `test_relay_correct.py` - 正确模型测试

### 文档
- `中转站使用指南.md` - 完整使用指南
- `中转站快速配置.md` - 本文档

---

## 🔧 配置说明

### 必需配置

| 配置项 | 说明 | 你的值 |
|--------|------|--------|
| `RELAY_ENABLED` | 启用中转站 | `true` |
| `RELAY_BASE_URL` | API 地址 | `https://api.yexc.top/v1` |
| `RELAY_API_KEY` | API Key | `sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q` |

### 可选配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `RELAY_CHAT_MODEL` | Chat 模型 | `grok-4-fast` |
| `RELAY_IMAGE_MODEL` | 图片模型 | `grok-imagine-0.9` |

---

## 🎯 使用示例

### 1. Chat Completions（推荐）

```bash
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer admin" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "grok-4-fast",
    "messages": [
      {"role": "user", "content": "介绍一下你自己"}
    ],
    "stream": false
  }'
```

### 2. 使用 API Key 管理系统

```bash
# 创建 API Key
curl -X POST http://localhost:9563/admin/api-keys \
  -H "Content-Type: application/json" \
  -d '{"name": "用户A", "daily_limit": 100}'

# 使用创建的 API Key
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer sk-your-created-key" \
  -d '{"model": "grok-4-fast", "messages": [...]}'
```

---

## 🔄 模式切换

### 切换到中转站模式

编辑 `.env`：
```env
RELAY_ENABLED=true
```

### 切换回直连模式

编辑 `.env`：
```env
RELAY_ENABLED=false
```

重启服务后生效。

---

## 📊 支持的模型

你的中转站支持以下模型：

### Chat 模型（已验证）
- ✅ `grok-4-fast` - 推荐
- ✅ `grok-3-fast`
- ✅ `grok-4-expert`
- ✅ `grok-4-fast-expert`
- ✅ `grok-4.1-thinking`
- ✅ `google/gemini-3-flash-preview`
- ✅ `openai/gpt-5-mini`
- ✅ `openai/gpt-5-nano`
- ✅ `openai/gpt-5.2`

### 图片生成模型（待确认）
- ⚠️ `grok-imagine-0.9` - 接口返回 404

---

## 🐛 故障排查

### 测试中转站连接

```bash
# 测试模型列表
python test_relay_models.py

# 测试 Chat 功能
python test_relay_correct.py
```

### 查看日志

```bash
# 查看实时日志
tail -f log.txt

# 查看最近的错误
grep ERROR log.txt | tail -20
```

### 常见问题

**Q: 图片生成返回 404？**
A: 中转站的图片生成接口可能未启用，建议使用直连模式或联系中转站提供商。

**Q: 如何同时使用两种模式？**
A: 目前系统会根据 `RELAY_ENABLED` 配置自动选择模式。如需混合使用，可以保留两套配置。

**Q: API Key 管理系统还能用吗？**
A: 可以！API Key 管理系统与中转站模式完全兼容。

---

## 🎉 总结

### 优势

1. **无需 SSO Token** - 不需要管理 Grok SSO Token
2. **更简单** - 使用标准的 OpenAI API 格式
3. **更稳定** - HTTP API 比 WebSocket 更稳定
4. **易于切换** - 可以随时切换模式

### 当前状态

- ✅ 中转站模式已实现
- ✅ Chat 功能已验证可用
- ✅ 配置文件已更新
- ⚠️ 图片生成功能待确认

---

## 📞 下一步

1. **配置 .env 文件** - 按照上面的配置修改
2. **重启服务** - `python main.py`
3. **测试 Chat 功能** - 使用上面的 curl 命令
4. **查看完整文档** - 阅读 `中转站使用指南.md`

---

**配置完成后，你就可以通过中转站使用服务了！** 🚀

如有问题，请查看 `中转站使用指南.md` 获取更多帮助。
