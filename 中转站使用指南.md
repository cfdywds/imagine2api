# 中转站模式使用指南

## 📋 概述

项目现在支持两种模式：

1. **直连模式**（原有方式）
   - 使用 Grok SSO Token
   - 通过 WebSocket 直连 Grok

2. **中转站模式**（新增）
   - 使用中转站 API Key
   - 通过 HTTP API 调用中转站
   - 中转站负责与 Grok 通信

---

## 🚀 快速开始

### 1. 配置中转站

编辑 `.env` 文件，添加以下配置：

```env
# ============ 中转站配置 ============
# 启用中转站模式
RELAY_ENABLED=true

# 中转站 API 地址
RELAY_BASE_URL=https://api.yexc.top/v1

# 中转站 API Key
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q

# 中转站支持的模型（可选配置）
RELAY_CHAT_MODEL=grok-4-fast
RELAY_IMAGE_MODEL=grok-imagine-0.9
```

### 2. 启动服务

```bash
python main.py
```

### 3. 使用接口

使用方式与之前完全相同，系统会自动使用中转站模式：

```bash
# Chat Completions（使用中转站）
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "grok-4-fast",
    "messages": [{"role": "user", "content": "Hello"}],
    "stream": false
  }'
```

---

## 🔧 配置说明

### 必需配置

| 配置项 | 说明 | 示例 |
|--------|------|------|
| `RELAY_ENABLED` | 是否启用中转站模式 | `true` 或 `false` |
| `RELAY_BASE_URL` | 中转站 API 地址 | `https://api.yexc.top/v1` |
| `RELAY_API_KEY` | 中转站 API Key | `sk-xxx...` |

### 可选配置

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `RELAY_CHAT_MODEL` | Chat 默认模型 | `grok-4-fast` |
| `RELAY_IMAGE_MODEL` | 图片生成默认模型 | `grok-imagine-0.9` |

---

## 📊 支持的模型

根据测试，你的中转站支持以下模型：

### Chat 模型
- `grok-3-fast`
- `grok-4-expert`
- `grok-4-fast` ✅ 推荐
- `grok-4-fast-expert`
- `grok-4.1-thinking`
- `google/gemini-3-flash-preview`
- `openai/gpt-5-mini`
- `openai/gpt-5-nano`
- `openai/gpt-5.2`

### 图片生成模型
- `grok-imagine-0.9` ✅ 推荐

---

## 🔄 模式切换

### 切换到中转站模式

编辑 `.env` 文件：
```env
RELAY_ENABLED=true
```

### 切换回直连模式

编辑 `.env` 文件：
```env
RELAY_ENABLED=false
```

重启服务后生效。

---

## 🎯 使用示例

### 1. Chat Completions

```bash
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "grok-4-fast",
    "messages": [
      {"role": "user", "content": "你好，请介绍一下自己"}
    ],
    "stream": false
  }'
```

### 2. 图片生成（如果中转站支持）

```bash
curl -X POST http://localhost:9563/v1/images/generations \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "grok-imagine-0.9",
    "prompt": "a cute cat",
    "n": 1,
    "size": "1024x1024"
  }'
```

---

## 📝 注意事项

### 1. 图片生成功能

根据测试，你的中转站的图片生成接口可能还不可用（返回 404）。建议：

- **Chat 功能**：使用中转站模式 ✅
- **图片生成**：暂时使用直连模式

### 2. 混合模式配置

如果你想 Chat 使用中转站，图片生成使用直连，可以这样配置：

```env
# 启用中转站（仅用于 Chat）
RELAY_ENABLED=true
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=sk-xxx

# 同时保留 SSO 配置（用于图片生成）
SSO_FILE=key.txt
```

然后修改代码，让图片生成接口强制使用直连模式。

### 3. API Key 管理

中转站模式下，你仍然可以使用之前实现的 API Key 管理系统：

```bash
# 创建 API Key
curl -X POST http://localhost:9563/admin/api-keys \
  -H "Content-Type: application/json" \
  -d '{"name": "用户A", "daily_limit": 100}'

# 使用 API Key
curl -X POST http://localhost:9563/v1/chat/completions \
  -H "Authorization: Bearer sk-your-created-api-key" \
  -d '{"model": "grok-4-fast", "messages": [...]}'
```

---

## 🔍 故障排查

### 问题 1: 中转站连接失败

**检查**：
```bash
# 测试中转站连接
python test_relay_correct.py
```

**解决**：
- 确认中转站 URL 正确
- 确认 API Key 有效
- 检查网络连接

### 问题 2: 模型不可用

**错误信息**：`model_not_found`

**解决**：
- 使用 `python test_relay_models.py` 查看支持的模型
- 使用正确的模型名称（如 `grok-4-fast`）

### 问题 3: 图片生成返回 404

**原因**：中转站的图片生成接口可能未启用

**解决**：
- 联系中转站提供商
- 或暂时使用直连模式生成图片

---

## 📊 性能对比

| 特性 | 直连模式 | 中转站模式 |
|------|----------|------------|
| 需要 SSO Token | ✅ 是 | ❌ 否 |
| 需要代理 | 可能需要 | 通常不需要 |
| 连接方式 | WebSocket | HTTP API |
| 稳定性 | 依赖 Grok | 依赖中转站 |
| 速度 | 较快 | 取决于中转站 |
| 成本 | SSO Token | API Key 计费 |

---

## 🎉 总结

### 优势

1. **无需 SSO Token**：不需要管理 Grok SSO Token
2. **更简单**：使用标准的 OpenAI API 格式
3. **更稳定**：HTTP API 比 WebSocket 更稳定
4. **易于扩展**：可以轻松切换不同的中转站

### 建议配置

**推荐配置**（Chat 使用中转站）：
```env
RELAY_ENABLED=true
RELAY_BASE_URL=https://api.yexc.top/v1
RELAY_API_KEY=sk-KxqASAFTrc4mkE1425v8W2mPZpWrSrPQqjhZm7cjpPA7yR0Q
RELAY_CHAT_MODEL=grok-4-fast
```

---

## 📞 技术支持

如有问题，请：
1. 查看日志：`tail -f log.txt`
2. 运行测试：`python test_relay_correct.py`
3. 查看 API 文档：http://localhost:9563/docs

---

**配置完成后，重启服务即可使用中转站模式！** 🚀
